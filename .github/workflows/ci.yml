name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: parallel-computing
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 24
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 24

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('parallel-computing/**/*.gradle*', 'parallel-computing/gradle.lockfile') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install OpenMPI 5.0.9
        id: openmpi
        run: |
          OMPI_DIR=$HOME/openmpi-5.0.9
          if [ ! -d "$OMPI_DIR" ]; then
            curl -L https://download.open-mpi.org/release/open-mpi/v5.0/openmpi-5.0.9.tar.gz -o openmpi.tar.gz
            tar xf openmpi.tar.gz
            cd openmpi-5.0.9
            ./configure --prefix=$OMPI_DIR
            make -j$(nproc)
            make install
          fi
          echo "OMPI_DIR=$OMPI_DIR" >> $GITHUB_ENV

      - name: Run all precompiled MPI executables
        working-directory: parallel-computing
        shell: bash -l {0}
        env:
          DYLD_LIBRARY_PATH: ${{ env.MPI_LIB }}:${{ env.DYLD_LIBRARY_PATH }}
          PATH: ${{ env.MPI_BIN }}:${{ env.PATH }}
          HOSTFILE: ${{ github.workspace }}/parallel-computing/hostfile
        run: |
          sudo apt-get update && sudo apt-get install -y coreutils findutils curl tar build-essential
          shopt -s nullglob
          for exe in lab*/executables/*; do
            if [[ "$(basename "$exe")" != "DeadlockProblem" ]]; then
              echo "Running $exe"
              "$exe"
            fi
          done

      - name: Build and run MPI executables
        run: |
          sudo apt-get update && sudo apt-get install -y coreutils findutils curl tar build-essential
          ./gradlew build runMpiAll
        shell: bash -l {0}
        env:
          PATH: ${{ env.OMPI_DIR }}/bin:$PATH
          LD_LIBRARY_PATH: ${{ env.OMPI_DIR }}/lib:$LD_LIBRARY_PATH
          MPI_LIB: ${{ env.OMPI_DIR }}/lib
          MPI_BIN: ${{ env.OMPI_DIR }}/bin

      - name: Build system-programming labs
        working-directory: system-programming
        run: make all

