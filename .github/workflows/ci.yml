name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 24
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 24

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('parallel-computing/**/*.gradle*', 'parallel-computing/gradle.lockfile') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install essential utilities
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential \
            coreutils \
            findutils \
            curl \
            tar \
            unzip \
            bzip2 \
            gzip

      - name: Install OpenMPI 5.0.9
        id: openmpi
        run: |
          OMPI_DIR=$HOME/openmpi-5.0.9
          if [ ! -d "$OMPI_DIR" ]; then
            curl -L https://download.open-mpi.org/release/open-mpi/v5.0/openmpi-5.0.9.tar.gz -o openmpi.tar.gz
            tar xf openmpi.tar.gz
            cd openmpi-5.0.9
            ./configure --prefix=$OMPI_DIR
            make -j$(nproc)
            make install
          fi
          echo "OMPI_DIR=$OMPI_DIR" >> $GITHUB_ENV
          echo "MPI_BIN=$OMPI_DIR/bin" >> $GITHUB_ENV
          echo "MPI_LIB=$OMPI_DIR/lib" >> $GITHUB_ENV

      - name: Run all precompiled MPI executables
        working-directory: parallel-computing
        env:
          PATH: ${{ env.MPI_BIN }}:/usr/bin:/bin:$PATH
          LD_LIBRARY_PATH: ${{ env.MPI_LIB }}:$LD_LIBRARY_PATH
          HOSTFILE: ${{ github.workspace }}/parallel-computing/hostfile
        run: |
          shopt -s nullglob
          for exe in lab*/executables/*; do
            if [[ "$(basename "$exe")" != "DeadlockProblem" ]]; then
              echo "Running $exe"
              chmod +x "$exe"
              "$exe" || { echo "$exe failed"; exit 1; }
            fi
          done

      - name: Build and run MPI executables via Gradle
        working-directory: parallel-computing
        run: ./gradlew build runMpiAll

      - name: Build system-programming labs
        working-directory: system-programming
        run: make all
